<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGaroto - Seu Portal de Estilo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper@8.4.7/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper@8.4.7/swiper-bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        html, body { overflow-x: hidden; width: 100%; }
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; position: relative; }
        .main-container { max-width: 1100px; margin: 0 auto; }
        .post-card { background-color: #ffffff; border: 1px solid #e5e7eb; }
        .sidebar-widget { background-color: #ffffff; border: 1px solid #e5e7eb; padding: 1.5rem; margin-bottom: 1.5rem; }
        .animated-gradient-text { font-weight: 900; background: linear-gradient(90deg, #ff6b6b, #ffc3c3, #ff6b6b); background-size: 200% 100%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shine 4s linear infinite; }
        @keyframes shine { to { background-position: -200% center; } }
        .story-slider .swiper-slide { text-align: center; font-size: 14px; }
        .story-slider .story-image-wrapper { width: 90px; height: 90px; border-radius: 50%; padding: 3px; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); margin: 0 auto 8px; }
        .story-slider img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 2px solid #fff; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: #ffffff; min-width: 120px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 50; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .dropdown-content a { color: black; padding: 10px 14px; text-decoration: none; display: block; text-align: left; font-size: 0.9rem; }
        .dropdown-content a:hover { background-color: #f1f1f1; }
        .dropdown:hover .dropdown-content { display: block; }
        .language-btn { border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; transition: all 0.2s ease-in-out; }
        .language-btn:hover { border-color: #c7c7c7; background-color: #f8f8f8; }
    </style>
</head>
<body class="text-gray-800">
    <div id="app">
        <div class="bg-white border-b border-gray-200">
            <div class="main-container px-4 py-2 flex justify-between items-center text-sm text-gray-600">
                <nav id="top-nav" class="flex gap-4"><a href="index.html" class="hover:text-indigo-600">Home</a></nav>
                <div class="flex gap-4 items-center"><a href="https://www.facebook.com/igaroto" target="_blank" class="hover:opacity-75"><i data-lucide="facebook" class="w-4 h-4"></i></a><a href="https://www.instagram.com/igaroto" target="_blank" class="hover:opacity-75"><i data-lucide="instagram" class="w-4 h-4"></i></a></div>
            </div>
        </div>
        <header class="bg-white sticky top-0 z-30 shadow-md">
            <div class="main-container px-4 py-4 flex justify-between items-center">
                <a href="index.html" class="text-4xl animated-gradient-text">iGAROTO</a>
                <nav class="hidden md:flex items-center gap-6">
                     <div class="dropdown"><button class="flex items-center gap-1 font-semibold hover:text-indigo-600">MENU</button><div class="dropdown-content"><a href="index.html">Home</a><a href="#">Boys</a><a href="#">Signos</a><a href="#">Sobre</a></div></div>
                    <div class="relative"><button id="search-icon-btn" class="hover:text-indigo-600"><i data-lucide="search" class="w-6 h-6"></i></button><div id="search-bar" class="hidden absolute top-full right-0 mt-2 w-64 z-50"><form id="search-form" method="GET" action="index.html"><input type="text" name="q" placeholder="Pesquisar..." class="w-full border border-gray-300 rounded-md p-2 shadow-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"></form></div></div>
                    <div class="dropdown"><button class="language-btn flex items-center gap-2"><span id="current-language-name">Português</span><i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i></button><div class="dropdown-content"><a href="javascript:void(0)" onclick="changeLanguage('pt')">Português</a><a href="javascript:void(0)" onclick="changeLanguage('en')">English</a><a href="javascript:void(0)" onclick="changeLanguage('es')">Español</a></div></div>
                </nav>
                <div class="md:hidden flex items-center gap-4">
                    <div class="dropdown"><button class="hover:text-indigo-600"><i data-lucide="globe" class="w-6 h-6"></i></button><div class="dropdown-content"><a href="javascript:void(0)" onclick="changeLanguage('pt')">Português</a><a href="javascript:void(0)" onclick="changeLanguage('en')">English</a><a href="javascript:void(0)" onclick="changeLanguage('es')">Español</a></div></div>
                    <button id="mobile-menu-btn" class="hover:text-indigo-600"><i data-lucide="menu" class="w-7 h-7"></i></button>
                </div>
            </div>
        </header>
        <div id="mobile-menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>
        <div id="mobile-menu" class="fixed top-0 left-0 h-full w-64 bg-white shadow-xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out">
            <div class="p-4 border-b flex justify-between items-center"><h2 class="font-bold text-xl">Menu</h2><button id="close-mobile-menu-btn" class="hover:text-red-500"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <nav class="mt-4"><a href="index.html" class="block py-3 px-4 text-base hover:bg-gray-100">Home</a><a href="#" class="block py-3 px-4 text-base hover:bg-gray-100">Boys</a><a href="#" class="block py-3 px-4 text-base hover:bg-gray-100">Signos</a><a href="#" class="block py-3 px-4 text-base hover:bg-gray-100">Sobre</a></nav>
        </div>
        
        <div id="main-content-area" class="main-container px-4 mt-8"></div>

        <footer class="bg-gray-800 text-white mt-12">
            <div class="main-container px-4 py-8 text-center"><p>&copy; 2024 iGaroto. Todos os direitos reservados.</p><p class="text-sm text-gray-400 mt-2">Desenvolvido com &hearts; para a comunidade.</p><a href="admin.html" target="_blank" class="mt-4 text-xs text-gray-500 hover:text-indigo-400">Admin Login</a></div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const languageNames = { pt: 'Português', en: 'English', es: 'Español' };
            const supportedLangs = ['pt', 'en', 'es'];
            let currentLanguage = 'pt';
            let swiperInstance = null;

            // Função para mudar de idioma, agora simplesmente recarrega a página com o parâmetro 'lang'
            window.changeLanguage = (lang) => {
                if (!supportedLangs.includes(lang)) return;
                const url = new URL(window.location);
                url.searchParams.set('lang', lang);
                url.searchParams.delete('post'); // Garante que volte para a home
                window.location.href = url.toString();
            };

            function renderTagSlider(posts) {
                const sliderContainer = document.getElementById('story-slider-container');
                if (!sliderContainer) return;

                if (swiperInstance) swiperInstance.destroy(true, true);
                
                const allTags = new Set();
                (posts || []).forEach(post => { (post.tags || []).forEach(tag => { if (typeof tag === 'string' && tag.trim() !== '') allTags.add(tag.trim()); }); });
                
                const uniqueTags = [...allTags];
                if (uniqueTags.length === 0) { sliderContainer.style.display = 'none'; return; }

                sliderContainer.innerHTML = '<div class="swiper"><div class="swiper-wrapper"></div></div>';
                const swiperWrapper = sliderContainer.querySelector('.swiper-wrapper');
                
                uniqueTags.forEach(tag => {
                    const latestPostForTag = (posts || []).find(p => (p.tags || []).includes(tag));
                    let imageUrl = '';
                    if (latestPostForTag && latestPostForTag.content) {
                        const firstImageMatch = (latestPostForTag.content || '').match(/<img src="([^"]+)"/);
                        if (firstImageMatch) imageUrl = firstImageMatch[1];
                    }
                    if (!imageUrl) {
                        const color = stringToColor(tag);
                        imageUrl = `https://placehold.co/110x110/${color.substring(1)}/ffffff?text=${encodeURIComponent(tag.charAt(0).toUpperCase())}`;
                    }
                    const slideEl = document.createElement('div');
                    slideEl.className = 'swiper-slide';
                    slideEl.innerHTML = `<a href="?tag=${encodeURIComponent(tag)}&lang=${currentLanguage}"><div class="story-image-wrapper"><img src="${imageUrl}" alt="${tag}"></div><span class="font-semibold">${tag}</span></a>`;
                    swiperWrapper.appendChild(slideEl);
                });
                
                swiperInstance = new Swiper('.story-slider .swiper', {
                    slidesPerView: 3, spaceBetween: 10, loop: true,
                    autoplay: { delay: 3000, disableOnInteraction: false },
                    breakpoints: { 640: { slidesPerView: 4 }, 768: { slidesPerView: 5 }, 1024: { slidesPerView: 6 } },
                });
            }

            function stringToColor(str) {
                if (!str) return '#cccccc';
                let hash = 0;
                for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
                let color = '#';
                for (let i = 0; i < 3; i++) color += ('00' + ((hash >> (i * 8)) & 0xFF).toString(16)).substr(-2);
                return color;
            }

            function renderPosts(posts) {
                const postsContainer = document.getElementById('posts-container');
                if (!postsContainer) return;
                
                postsContainer.innerHTML = ''; 
                (posts || []).forEach(post => {
                    if (!post || !post.id) return;
                    const postTitle = post.title || 'Post sem Título';
                    const postContent = post.content || '';
                    const postElement = document.createElement('article');
                    postElement.className = 'post-card flex flex-col md:flex-row rounded-lg overflow-hidden shadow-sm hover:shadow-xl transition-shadow duration-300';
                    const summary = postContent.substring(0, 150) + (postContent.length > 150 ? '...' : '');
                    const postDate = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
                    const firstImageMatch = (post.originalContent || post.content).match(/<img src="([^"]+)"/);
                    const imageUrl = firstImageMatch ? firstImageMatch[1] : `https://placehold.co/400x400/111827/ffffff?text=iGaroto`;
                    const category = post.tags && post.tags.length > 0 ? post.tags[0] : 'Novidades';

                    postElement.innerHTML = `<div class="md:w-1/3"><a href="?post=${post.id}"><img src="${imageUrl}" class="w-full h-full object-cover" alt="${postTitle}"></a></div><div class="p-6 flex flex-col justify-center md:w-2/3"><span class="text-white bg-red-600 px-2 py-1 text-xs font-bold rounded self-start mb-2">${category}</span><h3 class="text-2xl font-bold mb-2 hover:text-indigo-600"><a href="?post=${post.id}">${postTitle}</a></h3><p class="text-gray-600 text-sm mb-4">${summary}</p><div class="text-xs text-gray-500"><span>By <a href="#" class="font-semibold hover:text-black">iGaroto</a></span> - <span>${postDate}</span></div><a href="?post=${post.id}" class="text-indigo-600 font-semibold mt-4 self-start">LEIA MAIS &raquo;</a></div>`;
                    postsContainer.appendChild(postElement);
                });
            }
            
            async function initializeSite() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    let langFromUrl = urlParams.get('lang');

                    if (!langFromUrl) {
                        const userLang = (navigator.language || navigator.userLanguage || 'pt').slice(0, 2);
                        currentLanguage = supportedLangs.includes(userLang) ? userLang : 'pt';
                    } else {
                        currentLanguage = supportedLangs.includes(langFromUrl) ? langFromUrl : 'pt';
                    }
                    
                    document.documentElement.lang = currentLanguage;
                    document.getElementById('current-language-name').textContent = languageNames[currentLanguage];

                    mainContentArea.innerHTML = `<p class="text-center text-gray-600">Carregando conteúdo...</p>`;
                    
                    const response = await fetch(`/api/get-content?lang=${currentLanguage}`);
                    if (!response.ok) throw new Error('Falha ao carregar conteúdo do servidor.');
                    const { posts, layout } = await response.json();

                    document.getElementById('main-content-area').innerHTML = `<section id="story-slider-container" class="mb-8 story-slider"></section><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2"><h2 id="page-title" class="text-xl font-bold border-b-4 border-indigo-600 pb-2 mb-6 inline-block"></h2><div id="posts-container" class="space-y-8"></div></div><aside id="sidebar-container" class="lg:col-span-1"></aside></div>`;
                    
                    const searchTerm = urlParams.get('q');
                    const filterTag = urlParams.get('tag');
                    let postsToRender = posts;
                    const pageTitleEl = document.getElementById('page-title');

                    if (filterTag) {
                        pageTitleEl.textContent = `Mostrando posts com o marcador: "${filterTag}"`;
                        postsToRender = posts.filter(p => (p.tags || []).includes(filterTag));
                    } else if (searchTerm) {
                        pageTitleEl.textContent = `Resultados da busca por: "${searchTerm}"`;
                        postsToRender = posts.filter(p => (p.title || '').toLowerCase().includes(searchTerm.toLowerCase()));
                    } else {
                        pageTitleEl.textContent = 'POSTAGENS RECENTES';
                    }
                    
                    renderTagSlider(posts);
                    renderPosts(postsToRender);
                    
                    lucide.createIcons();
                    
                    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
                    if (mobileMenuBtn) { /* Lógica do menu preservada */ }
                    const searchIconBtn = document.getElementById('search-icon-btn');
                    if(searchIconBtn) { /* Lógica da busca preservada */ }

                } catch (error) {
                    console.error("Erro fatal ao inicializar o site:", error);
                    mainContentArea.innerHTML = `<p class="text-center text-red-500">Ocorreu um erro fatal ao carregar o site. Verifique o console para mais detalhes.</p>`;
                }
            }

            initializeSite();
        });
    </script>
</body>
</html>