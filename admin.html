<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - iGaroto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Lato:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo@4.3.0/build/index.umd.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f1f3f4;
        }
        .sidebar-item.active {
            background-color: #e8f0fe;
            color: #1967d2;
            font-weight: 700;
        }
        .sidebar-item.active i {
            color: #1967d2;
        }
        .admin-view { display: none; }
        .active-view { display: block !important; }
        #post-editor-container, #page-editor-container {
            height: 60vh;
            background-color: white;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        .ql-toolbar.ql-snow {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-color: #d1d5db;
        }
        .ql-container.ql-snow {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            border-color: #d1d5db;
            border-top: 0px;
        }
        .ql-font-roboto { font-family: 'Roboto', sans-serif; }
        .ql-font-lato { font-family: 'Lato', sans-serif; }
        .ql-font-merriweather { font-family: 'Merriweather', serif; }
        .ql-font-arial { font-family: Arial, sans-serif; }
        .list-item .item-actions, .gadget .gadget-actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .list-item:hover .item-actions, .gadget:hover .gadget-actions { opacity: 1; }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 50;
            right: 0;
            border-radius: 8px;
        }
        .dropdown-content a:hover {background-color: #f1f1f1}
        .dropdown:hover .dropdown-content { display: block; }
        .comment-actions { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .comment-item:hover .comment-actions { opacity: 1; }
        .comments-tab.active { border-color: #1967d2; color: #1967d2; }
        .gadget-container {
            border: 2px dashed #d1d5db;
            padding: 1rem;
            border-radius: 8px;
            min-height: 100px;
        }
        .gadget { cursor: grab; user-select: none; }
        .gadget.dragging { opacity: 0.5; background: #e8f0fe; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .theme-card { border: 2px solid transparent; transition: border-color 0.2s ease-in-out; }
        .theme-card.active { border-color: #1967d2; }
        .theme-card .apply-button-container { display: none; }
        .theme-card.active .apply-button-container { display: block; }
        .setting-item { padding: 1rem 0; border-bottom: 1px solid #e5e7eb; }
        .setting-item:last-child { border-bottom: none; }
        .setting-item h4 { font-size: 1rem; font-weight: 500; color: #111827; }
        .setting-item p { font-size: 0.875rem; color: #6b7280; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); width: 36px; height: 36px; border-radius: 50%; border-left-color: #ffffff; animation: spin 1s ease infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Admin iGaroto</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Senha</label>
                    <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Entrar
                    </button>
                </div>
                <p id="login-error" class="text-red-500 text-xs italic mt-4 text-center"></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden h-screen bg-gray-100">
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-700">iGAROTO</h1>
                <button id="logout-btn" title="Sair" class="text-gray-500 hover:text-red-600">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4">
                <button id="new-post-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg inline-flex items-center justify-center shadow hover:bg-orange-600 transition-colors">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                    <span>NOVA POSTAGEM</span>
                </button>
            </div>
            <nav id="sidebar-nav" class="flex-1 py-2 px-2 space-y-1">
                <a href="#" id="posts-link" class="sidebar-item flex items-center px-4 py-2 text-gray-700 rounded-r-full hover:bg-gray-200">
                    <i data-lucide="layout-list" class="w-5 h-5 mr-3 text-gray-500"></i>Postagens
                </a>
                <a href="#" id="stats-link" class="sidebar-item flex items-center px-4 py-2 text-gray-700 rounded-r-full hover:bg-gray-200">
                    <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3 text-gray-500"></i>Estatísticas
                </a>
                <a href="#" id="comments-link" class="sidebar-item flex items-center px-4 py-2 text-gray-700 rounded-r-full hover:bg-gray-200">
                    <i data-lucide="message-square" class="w-5 h-5 mr-3 text-gray-500"></i>Comentários
                </a>
                <a href="#" id="pages-link" class="sidebar-item flex items-center px-4 py-2 text-gray-700 rounded-r-full hover:bg-gray-200">
                    <i data-lucide="file-text" class="w-5 h-5 mr-3 text-gray-500"></i>Páginas
                </a>
                <a href="#" id="layout-link" class="sidebar-item flex items-center px-4 py-2 text-gray-700 rounded-r-full hover:bg-gray-200">
                    <i data-lucide="layout-template" class="w-5 h-5 mr-3 text-gray-500"></i>Layout
                </a>
                <a href="#" id="theme-link" class="sidebar-item flex items-center px-4 py-2 text-gray-700 rounded-r-full hover:bg-gray-200">
                    <i data-lucide="palette" class="w-5 h-5 mr-3 text-gray-500"></i>Tema
                </a>
                <a href="#" id="settings-link" class="sidebar-item flex items-center px-4 py-2 text-gray-700 rounded-r-full hover:bg-gray-200">
                    <i data-lucide="settings" class="w-5 h-5 mr-3 text-gray-500"></i>Configurações
                </a>
            </nav>
            <div class="px-4 py-2 border-t">
                <a href="index.html" target="_blank" class="sidebar-item flex items-center px-4 py-2 text-gray-700 rounded-lg hover:bg-gray-200">
                    <i data-lucide="eye" class="w-5 h-5 mr-3 text-gray-500"></i>Ver blog
                </a>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header id="main-header" class="bg-white border-b border-gray-200 p-2">
                 <div class="flex items-center justify-between">
                    <div class="relative w-full max-w-md">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        <input type="text" placeholder="Pesquisar" class="w-full bg-gray-100 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-center gap-4">
                        <button class="text-gray-500 hover:text-gray-800"><i data-lucide="help-circle" class="w-6 h-6"></i></button>
                        <img id="user-avatar" src="https://placehold.co/40x40/ff8a8a/ffffff?text=W" alt="User Avatar" class="w-8 h-8 rounded-full cursor-pointer">
                    </div>
                </div>
            </header>
            <header id="editor-header" class="hidden bg-white border-b border-gray-200 p-2 items-center justify-between">
                <div class="flex items-center gap-2">
                    <button id="back-btn" class="text-gray-500 hover:text-gray-800 p-2 rounded-full hover:bg-gray-100">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i>
                    </button>
                    <input id="editor-title-input" type="text" placeholder="Título da postagem" class="text-2xl bg-transparent focus:outline-none w-full placeholder-gray-400 font-normal">
                </div>
                <div class="flex items-center gap-3 mr-4">
                    <button id="publish-btn" class="text-sm text-white bg-orange-500 hover:bg-orange-600 px-5 py-2 rounded-md font-bold">Publicar</button>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                
                <div id="posts-list-view" class="admin-view">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-normal text-gray-800">Postagens</h2>
                    </div>
                    <div id="posts-container" class="bg-white rounded-lg shadow-sm border border-gray-200"></div>
                </div>

                <div id="post-editor-view" class="admin-view">
                     <div class="flex flex-col lg:flex-row gap-6">
                         <div class="flex-1">
                             <div id="post-editor-wrapper">
                                 <div id="post-editor-container"></div>
                             </div>
                         </div>
                         <aside class="w-full lg:w-80">
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 space-y-6">
                                <div>
                                    <h3 class="font-bold text-sm mb-3 border-b pb-2">Configurações da postagem</h3>
                                    <label for="tags-input" class="block text-sm font-medium text-gray-700 mb-1">Marcadores</label>
                                    <input type="text" id="tags-input" placeholder="Separe com vírgulas" class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <h3 class="font-bold text-sm mb-2 border-b pb-2 pt-2">Opções</h3>
                                    <label for="post-comments-select" class="block text-sm font-medium text-gray-700 mb-1">Comentários</label>
                                    <select id="post-comments-select" class="w-full border border-gray-300 rounded-md p-2 text-sm">
                                        <option value="allow">Permitir</option>
                                        <option value="disallow">Não permitir</option>
                                    </select>
                                </div>
                            </div>
                         </aside>
                     </div>
                </div>
            </main>
        </div>
    </div>

    <div id="upload-modal" class="modal-overlay hidden">
        <div class="spinner"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    
        const firebaseConfig = {
          apiKey: "AIzaSyBYvn_AEoXo2ei2zRSg9EZhAeicF0QfY3s",
          authDomain: "igaroto-site-oficial.firebaseapp.com",
          projectId: "igaroto-site-oficial",
          storageBucket: "igaroto-site-oficial.firebasestorage.app",
          messagingSenderId: "217633468562",
          appId: "1:217633468562:web:236b1b72034a5a675cb64b"
        };
        
        firebase.initializeApp(firebaseConfig);
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');

        function showApp() {
            loginScreen.style.display = 'none';
            appContainer.style.display = 'flex';
            runApp();
        }

        function showLogin() {
            loginScreen.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        auth.onAuthStateChanged(user => {
            if (user && !user.isAnonymous) {
                showApp();
            } else {
                showLogin();
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error('Erro de login:', error);
                    loginError.textContent = 'E-mail ou senha inválidos.';
                });
        });

        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        function runApp() {
            const elements = {
                publishBtn: document.getElementById('publish-btn'),
                editorTitleInput: document.getElementById('editor-title-input'),
                tagsInput: document.getElementById('tags-input'),
                postsContainer: document.getElementById('posts-container'),
                newPostBtn: document.getElementById('new-post-btn'),
                backBtn: document.getElementById('back-btn'),
                postsLink: document.getElementById('posts-link')
            };
            const views = {
                posts: document.getElementById('posts-list-view'),
                postEditor: document.getElementById('post-editor-view')
            };
            let currentEditor = null;
            const uploadModal = document.getElementById('upload-modal');

            // NOVA LÓGICA DE UPLOAD DE IMAGEM PARA A VERCEL
            async function vercelBlobUpload(file) {
                uploadModal.classList.remove('hidden');
                // Faz uma chamada para uma API interna que vai pedir um URL de upload para a Vercel
                const response = await fetch(`/api/upload-image?filename=${file.name}`, {
                    method: 'POST',
                    body: file,
                });
                const newBlob = await response.json();
                uploadModal.classList.add('hidden');
                return newBlob.url;
            }
            
            function imageHandler() {
                const input = document.createElement('input');
                input.setAttribute('type', 'file');
                input.setAttribute('accept', 'image/*');
                input.click();
                input.onchange = async () => {
                    const file = input.files[0];
                    if (!file) return;

                    try {
                        const url = await vercelBlobUpload(file);
                        const range = this.quill.getSelection(true);
                        this.quill.insertEmbed(range.index, 'image', url);
                    } catch (error) {
                        console.error('Falha no upload da imagem:', error);
                        alert('Falha no upload da imagem. Verifique o console.');
                        uploadModal.classList.add('hidden');
                    }
                };
            }

            const quillOptions = {
                modules: {
                    toolbar: {
                        container: [
                            [{ 'font': [] }, { 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'], ['blockquote', 'code-block'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'align': [] }], ['link', 'image'], ['clean']
                        ],
                        handlers: { 'image': imageHandler }
                    }
                },
                theme: 'snow',
                placeholder: 'Comece a escrever sua história...'
            };
            const postQuill = new Quill('#post-editor-container', quillOptions);

            const renderPosts = async () => {
                try {
                    elements.postsContainer.innerHTML = '<p class="p-4 text-center text-gray-500">Carregando postagens...</p>';
                    const snapshot = await db.collection('posts').orderBy('createdAt', 'desc').get();
                    if (snapshot.empty) {
                        elements.postsContainer.innerHTML = `<p class="p-4 text-center text-gray-500">Nenhuma postagem encontrada.</p>`;
                        return;
                    }
                    elements.postsContainer.innerHTML = '';
                    snapshot.forEach(doc => {
                        const post = { id: doc.id, ...doc.data() };
                        const el = document.createElement('div');
                        el.className = 'list-item flex items-center p-4 border-b last:border-b-0';
                        const postDate = post.createdAt && post.createdAt.toDate ? new Date(post.createdAt.toDate()).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' }) : 'Data indisponível';
                        el.innerHTML = `<div class="flex-1 cursor-pointer" onclick="window.editPost('${post.id}')"><p class="font-medium text-gray-800 hover:underline">${post.title || '(Sem título)'}</p><div class="text-sm text-gray-500 mt-1"><span>Publicada</span> &middot; <span>${postDate}</span></div></div><div class="item-actions flex items-center gap-3 text-gray-500"><button onclick="window.deletePost('${post.id}')" title="Excluir" class="hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                        elements.postsContainer.appendChild(el);
                    });
                    lucide.createIcons();
                } catch (error) {
                    console.error("Erro ao carregar as postagens: ", error);
                    elements.postsContainer.innerHTML = `<p class="p-4 text-center text-red-500">Ocorreu um erro ao carregar as postagens.</p>`;
                }
            };

            window.editPost = async (id) => {
                try {
                    const docSnap = await db.collection('posts').doc(id).get();
                    if (docSnap.exists) {
                        const post = docSnap.data();
                        currentEditor = 'post';
                        elements.editorTitleInput.value = post.title;
                        elements.tagsInput.value = post.tags ? post.tags.join(', ') : '';
                        postQuill.root.innerHTML = post.content;
                        elements.publishBtn.dataset.id = id;
                        switchView('postEditor');
                    }
                } catch (error) {
                    console.error("Erro ao buscar postagem para edição: ", error);
                }
            };

            window.deletePost = async (id) => {
                if (confirm('Tem certeza que deseja excluir esta postagem permanentemente?')) {
                    try {
                        await db.collection('posts').doc(id).delete();
                        renderPosts();
                    } catch (error) {
                        console.error("Erro ao deletar postagem: ", error);
                    }
                }
            };

            elements.publishBtn.addEventListener('click', async () => {
                const id = elements.publishBtn.dataset.id;
                const title = elements.editorTitleInput.value.trim();
                if (!title) return alert('Por favor, adicione um título.');

                const postData = {
                    title: title,
                    content: postQuill.root.innerHTML,
                    tags: elements.tagsInput.value.split(',').map(t => t.trim()).filter(Boolean),
                    status: 'Publicada',
                    updatedAt: new Date()
                };
                
                try {
                    if (id) {
                        await db.collection('posts').doc(id).update(postData);
                    } else {
                        postData.createdAt = new Date();
                        await db.collection('posts').add(postData);
                    }
                    switchView('posts');
                    renderPosts();
                } catch (error) {
                    console.error("Erro ao salvar postagem: ", error);
                    alert("Ocorreu um erro ao salvar a postagem. Verifique o console.");
                }
            });
            
            const switchView = (viewKey) => {
                Object.values(views).forEach(v => v.style.display = 'none');
                views[viewKey].style.display = 'block';
                document.getElementById('main-header').style.display = viewKey === 'postEditor' ? 'none' : 'flex';
                document.getElementById('editor-header').style.display = viewKey === 'postEditor' ? 'flex' : 'none';
            };

            elements.newPostBtn.addEventListener('click', () => {
                currentEditor = 'post';
                elements.editorTitleInput.value = '';
                elements.tagsInput.value = '';
                postQuill.root.innerHTML = '';
                elements.publishBtn.dataset.id = '';
                switchView('postEditor');
            });
            
            elements.backBtn.addEventListener('click', () => {
                switchView('posts');
                renderPosts();
            });
            
            elements.postsLink.addEventListener('click', (e) => { e.preventDefault(); switchView('posts'); renderPosts(); });
            
            lucide.createIcons();
            switchView('posts');
            renderPosts();
        }
    });
    </script>
</body>
</html>